---
interface Props {
  jobs: any[];
}

const { jobs } = Astro.props;

// Extraer todos los tags únicos de todas las experiencias
const allTags = new Set<string>();
jobs.forEach(job => {
  if (job.tags) {
    job.tags.forEach((tag: string) => allTags.add(tag));
  }
});

// Ordenar tags alfabéticamente
const sortedTags = Array.from(allTags).sort();

// Categorizar tags para mejor organización
const tagCategories = {
  'Technologies': ['NestJS', 'Angular', 'PHP', 'CodeIgniter', 'MySQL', 'Docker', 'AWS'],
  'Skills': ['Migration', 'Architecture', 'Leadership', 'SQL Optimization', 'Git', 'Reporting'],
  'Domains': ['Payments', 'B2B Integration', 'Order Management', 'Trade Marketing', 'ISO 27001'],
  'Other': ['Backend', 'Freelance']
};

// Categorías más buscadas por reclutadores (top keywords)
const topKeywords = [
  'NestJS',
  'Migration',
  'Docker',
  'AWS',
  'B2B Integration',
  'Architecture',
  'Payments',
  'Leadership',
  'Angular',
  'MySQL'
];
---

<div class="experience-filter">
  <div class="filter-section">
    <h3 class="filter-title">Buscar por Skills</h3>
    <p class="filter-description">Filtra mi experiencia por las habilidades más buscadas</p>

    <!-- Top Keywords (Más buscados) -->
    <div class="filter-group">
      <h4 class="group-title">Top Keywords</h4>
      <div class="tags-container" id="filter-buttons">
        {topKeywords.filter(tag => allTags.has(tag)).map((tag) => (
          <button
            class="tag-button"
            data-tag={tag}
          >
            {tag}
          </button>
        ))}
      </div>
    </div>

    <!-- Todos los tags -->
    <details class="all-tags-details">
      <summary>Ver todos los tags</summary>
      <div class="tags-container">
        {sortedTags.map((tag) => (
          <button
            class="tag-button small"
            data-tag={tag}
          >
            {tag}
          </button>
        ))}
      </div>
    </details>

    <!-- Botón para limpiar filtros -->
    <button id="clear-filter" class="clear-button" style="display: none;">
      Mostrar toda mi experiencia
    </button>
  </div>
</div>

<script>
  // Cliente-side JavaScript para filtrado interactivo
  function initializeFilters() {
    const filterButtons = document.querySelectorAll('.tag-button');
    const clearButton = document.getElementById('clear-filter');
    const jobEntries = document.querySelectorAll('.job-entry');

    let activeFilter: string | null = null;

    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tag = button.getAttribute('data-tag');

        if (activeFilter === tag) {
          // Si ya está activo, desactivar
          clearFilters();
        } else {
          // Activar nuevo filtro
          activeFilter = tag;
          applyFilter(tag);

          // Actualizar botones
          filterButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');

          clearButton!.style.display = 'inline-block';
        }
      });
    });

    clearButton?.addEventListener('click', clearFilters);

    function applyFilter(tag: string | null) {
      jobEntries.forEach(jobEntry => {
        const jobTags = Array.from(jobEntry.querySelectorAll('.tag')).map(
          tagEl => tagEl.textContent?.trim()
        );

        if (!tag || jobTags.includes(tag)) {
          jobEntry.classList.remove('filtered-out');
          jobEntry.classList.add('filtered-in');
        } else {
          jobEntry.classList.remove('filtered-in');
          jobEntry.classList.add('filtered-out');
        }
      });

      // Scroll suave a la sección de experiencia
      if (tag) {
        const experienceSection = document.querySelector('#experience-section');
        experienceSection?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function clearFilters() {
      activeFilter = null;
      filterButtons.forEach(btn => btn.classList.remove('active'));
      jobEntries.forEach(entry => {
        entry.classList.remove('filtered-out', 'filtered-in');
      });
      clearButton!.style.display = 'none';
    }
  }

  // Inicializar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeFilters);
  } else {
    initializeFilters();
  }
</script>

<style>
  .experience-filter {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: var(--gradient-subtle);
    border-radius: 1rem;
    border: 1px solid var(--gray-800);
  }

  .filter-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .filter-title {
    font-size: var(--text-xl);
    color: var(--gray-0);
    margin: 0;
  }

  .filter-description {
    font-size: var(--text-sm);
    color: var(--gray-300);
    margin: 0;
  }

  .filter-group {
    margin-top: 0.5rem;
  }

  .group-title {
    font-size: var(--text-md);
    color: var(--gray-100);
    margin-bottom: 0.75rem;
    font-weight: 600;
  }

  .tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag-button {
    display: inline-block;
    padding: 0.5rem 1rem;
    font-size: var(--text-sm);
    font-weight: 500;
    background: var(--gray-800);
    color: var(--gray-200);
    border: 2px solid var(--gray-700);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .tag-button:hover {
    background: var(--accent-regular);
    color: var(--accent-text-over);
    border-color: var(--accent-regular);
    transform: translateY(-2px);
  }

  .tag-button.active {
    background: var(--accent-regular);
    color: var(--accent-text-over);
    border-color: var(--accent-dark);
    box-shadow: 0 0 0 3px var(--accent-overlay);
  }

  .tag-button.small {
    padding: 0.35rem 0.75rem;
    font-size: 0.85rem;
  }

  .clear-button {
    padding: 0.75rem 1.5rem;
    font-size: var(--text-md);
    font-weight: 600;
    background: var(--gray-700);
    color: var(--gray-100);
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 0.5rem;
  }

  .clear-button:hover {
    background: var(--gray-600);
    transform: translateY(-2px);
  }

  .all-tags-details {
    margin-top: 1rem;
  }

  .all-tags-details summary {
    cursor: pointer;
    color: var(--accent-regular);
    font-weight: 500;
    user-select: none;
    padding: 0.5rem;
    list-style: none;
  }

  .all-tags-details summary::-webkit-details-marker {
    display: none;
  }

  .all-tags-details summary:hover {
    color: var(--accent-dark);
  }

  .all-tags-details[open] summary {
    margin-bottom: 1rem;
  }

  /* Animaciones para filtrado */
  :global(.job-entry) {
    transition: all 0.3s ease;
  }

  :global(.job-entry.filtered-out) {
    opacity: 0.3;
    max-height: 0;
    overflow: hidden;
    margin: 0;
    padding: 0;
  }

  :global(.job-entry.filtered-in) {
    opacity: 1;
    background: var(--accent-subtle-overlay);
    border-left: 4px solid var(--accent-regular);
    padding-left: 1rem;
  }

  @media (max-width: 768px) {
    .tag-button {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }
  }
</style>
